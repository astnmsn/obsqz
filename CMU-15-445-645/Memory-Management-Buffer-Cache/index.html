<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Managing the movement of data Spatial Control
 Where to write pages on disk Keep data that is often accessed together, as physically close together as possible to take advantage of sequential performance of disks Temporal Control When to move data into memory and when to flush it back out to disk Disk I/O is the main bottleneck of the system, so the goal is to reduce the number of operations that require interaction with the disk The system needs to be aware which process is updating memory, so it knows when it is safe to flush (dirty records) to disk Execution engine should be unaware of this memory management, queries only require that the underlying storage system returns a pointer to the relevant data in memory (location in the buffer pool)."><title>obsqz notes</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://astnmsn.github.io/icon.png><link href=https://astnmsn.github.io/styles.547fb332ce56cdc523146ba5ede80d7f.min.css rel=stylesheet><link href=https://astnmsn.github.io/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://astnmsn.github.io/js/darkmode.18cad7e2a3e6f467e27f689e56c2ce98.min.js></script>
<script src=https://astnmsn.github.io/js/util.6f22941e242efae60fd84e7c32e874fa.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script async src=https://astnmsn.github.io/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://astnmsn.github.io/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://astnmsn.github.io/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://astnmsn.github.io/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://astnmsn.github.io",fetchData=Promise.all([fetch("https://astnmsn.github.io/indices/linkIndex.e77416d15b21f300430f657f3a41b113.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://astnmsn.github.io/indices/contentIndex.2c9c5b36e2c83f2068bee29799c04e89.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://astnmsn.github.io",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://astnmsn.github.io",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/astnmsn.github.io\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://astnmsn.github.io/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://astnmsn.github.io>obsqz notes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Jan 26, 2023
<a href=https://github.com/astnmsn/astnmsn.github.io/tree/main/content/CMU%2015-445-645/Memory%20Management%20&%20Buffer%20Cache.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><ol><li></li></ol></li></ol></nav></details></aside><a href=#managing-the-movement-of-data><h4 id=managing-the-movement-of-data><span class=hanchor arialabel=Anchor># </span>Managing the movement of data</h4></a><p>Spatial Control</p><ul><li>Where to write pages on disk</li><li>Keep data that is often accessed together, as physically close together as possible to take advantage of sequential performance of disks
Temporal Control</li><li>When to move data into memory and when to flush it back out to disk</li><li>Disk I/O is the main bottleneck of the system, so the goal is to reduce the number of operations that require interaction with the disk</li><li>The system needs to be aware which process is updating memory, so it knows when it is safe to flush (dirty records) to disk
Execution engine should be unaware of this memory management, queries only require that the underlying storage system returns a pointer to the relevant data in memory (location in the buffer pool).</li></ul><a href=#buffer-pool><h4 id=buffer-pool><span class=hanchor arialabel=Anchor># </span>Buffer Pool</h4></a><ul><li>Memory region organized as an array of fixed-size pages (Database page)</li><li>An array is called a <em><strong>frame</strong></em></li><li>When the database requests a page, an exact copy is read from disk and placed into one of these frames</li><li>Dirty pages are buffered and not written to disk immediately (Write-Back Cache), to minimize the number of I/O operations
Page Table</li><li>Keeps track of pages that are currently in memory</li><li>Routes page id requests to a particular frame</li><li>Also maintains additional metadata per page<ul><li>Dirty Flag</li><li>Pin/Reference Counter<ul><li>How many processes are actively utilizing the page</li><li>A value of true/>0 signifies that the Buffer Pool Manager should not evict the page from memory</li></ul></li></ul></li><li>A latch is placed around an entry in the frame when it is being modified so that it cannot be altered by another thread</li></ul><p>Aside: Locks vs Latches</p><ul><li>Lock: protects database&rsquo;s logical contents from other transactions</li><li>Latch: protects critical sections of the system&rsquo;s internal data structure from other threads (mutex)</li></ul><p>Page Directory</p><ul><li>The mapping from page ids to page locations in database files</li><li>This structure is required for maintaining the coherency of the underlying data and must itself be persisted to disk</li><li>This allows the system to reconstruct the mapping on restart
Page Table</li><li>The mapping from page ids to the location of a copy of the pages that have been brought into buffer pool frames</li><li>Because the buffer pool itself is ephemeral, the page table does not need to be persisted, and would not be reconstructed on a restart (although some systems do allow for this at the cost of some ongoing performance cost, it can improve performance at the early moments of a restart as failed queries are likely going to be retried)</li></ul><a href=#allocation-policies><h4 id=allocation-policies><span class=hanchor arialabel=Anchor># </span>Allocation Policies</h4></a><p>Global Policies -> All active queries
Local Policies -> Allocate frames to specific queries without considering the behavior of other concurrent queries. This still requires support for sharing pages. This can have adverse effects on the performance of contending threads if the allotment of memory is not equal.</p><a href=#buffer-pool-optimizations><h4 id=buffer-pool-optimizations><span class=hanchor arialabel=Anchor># </span>Buffer Pool Optimizations</h4></a><p>Multiple Buffer Pools</p><ul><li>Per-database buffer pool</li><li>Per-page type buffer pool</li><li>Partitioning memory across multiple pools helps<ul><li>reduce latch contention -> fewer queries per table means that the load associated with managing the latches is spread across multiple tables</li><li>improve locality</li><li>records must always map to the same pool so that there are never multiple instances of the page in separate buffer pools (coherency issues with determining if it is dirty)</li><li>can maintain different eviction policies for each pool</li></ul></li><li>Object id<ul><li>Embed an object identifier in record ids and the maintain a mapping from objects to specific buffer pools</li></ul></li><li>Hashing<ul><li>Hash the page id to select which buffer pool to access</li></ul></li></ul><p>Prefetching</p><ul><li>The system can also prefetch pages based on a query plan<ul><li>Sequential Scans<ul><li>bring in multiple sequential pages at once</li><li>can evict previous pages in the scan to prefetch these additional pages</li></ul></li><li>Index Scans<ul><li>can prefetch pages that follow sibling pointers at the leaves of a B+ tree (these would not be contiguous on disk)</li></ul></li><li>Scan Sharing (Synchronized Scans)<ul><li>Queries can reuse data retrieved from storage or operator computations (not the same as result cacheing at a higher layer)</li><li>Allow multiple queries to attach to a single cursor that scans a table</li><li>Queries do not have to be the same</li><li>Can share intermediate result</li><li>Query that is piggy-backing must fetch the data it missed</li><li>Prevents thrashing of buffer pool</li><li>Can result in different results for a query (LIMIT) -> but this is allowed in the relational model</li></ul></li><li>Buffer Pool Bypass<ul><li>The sequential scan operator will not store fetched pages in the buffer pool to avoid overhead</li><li>Memory is local to the running query</li><li>Works well if operator needs to read a large sequence of pages that are contiguous on disk</li><li>Can also be used for temporary data (sorting, joins)</li><li>Good if the data is not likely to be used by another query for a long time as it prevents cluttering the global memory pool with data that is unlikely to be used by another thread</li></ul></li><li>OS Page Cache<ul><li>Most disk operations go through the OS API</li><li>Unless the database system tell it not to, the OS maintains its own filesystem cache (aka page cache, buffer cache)</li><li>Most systems use direct I/O to bypass the OS&rsquo;s cache, preventing redundant copies and cache eviction policies that are unaware of the workload being run</li></ul></li></ul></li></ul><p>Buffer Replacement Policies</p><p>When the database needs to free up a frame to make room for a new page, it must decide which page to evict from the buffer pool.</p><p>The system will need to utilize a heuristic to determine which entry is the least likely to be used next.</p><ul><li><p>Least Recently Used</p><ul><li>Maintain timestamp along the entry for when it was last accessed</li><li>When deciding what page to evict, select the page with the oldest timestamp</li><li>Can keep the pages in sorted order to reduce the time to find that entry</li></ul></li><li><p>Clock</p><ul><li>Approximation of LRU that utilizes a single reference bit</li><li>When a page is accessed, set the bit to 1</li><li>Organize the pages in a circular buffer. When determining which page to evict, iterate through the buffer, if a page&rsquo;s bit is set to one, zero it. If it is set to zero, then evict.</li><li>Less metadata to track than LRU. No need to maintain sort of entries by timestamp which makes it less expensive to calculate
Both of these options are suscpetible to sequential flooding. Sequential scans pollute the buffer pool with pages that are read once, and then not again for a very long time. In a workload with a high amount of sequential scans, the most recently used page is the most unneeded page.</li></ul></li><li><p>LRU-K</p><ul><li>Track the history of last K references to each page as timestamps and compute the interval between subsequent accesses</li><li>The system will use this history to estimate the next time that page is likely to be accessed, chooses the one that has the timestamp that is the furthest in the future</li><li>If a page has not been accessed k times when performing the eviction, set the value to infinity (evict immediately)</li></ul></li><li><p>Localization</p><ul><li>The database system choose which pages to evict on a per query basis. This minimizes the pollution of the buffer pool from each query</li><li>Ex: Postgres maintains a small ring buffer that is private to the query</li></ul></li><li><p>Priority Hints</p><ul><li>The system know about the context of each page during the query execution</li><li>Can provide hints to the buffer pool on whether a page is important or not</li><li>Ex: Query that utilizes an index should set a preference to maintain pages in the cache for nodes that are higher in the B+ tree</li></ul></li><li><p>Dirty Pages</p><ul><li>Fast Path: If a page is not dirty, the the DBMS can simply drop it</li><li>Slow Path: If the page is dirty, the system must flush it to disk to ensure that changes are persisted</li><li>This leads to a trade off between fast evictions and dirty writing pages that will not be read again in the future</li><li>Background writing<ul><li>Periodically walk through the page table and write dirty pages to disk</li><li>At this point the system can either simply clear the dirty flag, or evict the page</li></ul></li></ul></li></ul><p>Other memory Pools</p><ul><li>Sorting & Join buffers</li><li>Query Caches</li><li>Maintenance buffers</li><li>Log buffers</li><li>Dictionary caches</li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://astnmsn.github.io/js/graph.2d9e48dbe7ea47c0ef1c58296ce14448.js></script></div></div><div id=contact_buttons><footer><p>Made by Austin Mason using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://astnmsn.github.io>Home</a></li><li><a href=https://github.com/astnmsn>GitHub</a></li></ul></footer></div></div></body></html>